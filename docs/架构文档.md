# Jdatabase 技术架构文档

## 1. 项目概述

Jdatabase 是一个使用 Java 实现的轻量级关系型数据库系统，实现了从 SQL 解析、查询优化、存储管理到事务处理的完整数据库核心功能。

### 1.1 核心特性

- **SQL 解析器**：支持标准 SQL 语句解析（SELECT、INSERT、UPDATE、DELETE、CREATE TABLE）
- **存储引擎**：基于页式存储的数据管理系统
- **索引系统**：B+ 树索引实现，支持快速数据检索
- **缓冲池管理**：LRU 缓存策略，优化磁盘 I/O 性能
- **事务管理**：支持 ACID 特性的事务处理
- **锁机制**：实现行级锁和表级锁，支持并发控制
- **查询优化器**：基于规则和代价的查询优化
- **执行引擎**：支持多种关系代数操作符
- **JDBC 驱动**：完整的 JDBC 接口实现，支持标准数据库访问

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        应用层 (Application)                   │
│                    JDBC API / Direct API                     │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                        接口层 (Interface)                     │
│                    JDBC Driver Implementation                │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据库引擎 (Engine)                       │
│                         Database.java                        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    SQL 解析层 (Parser Layer)                  │
│              Lexer → Parser → AST (Abstract Syntax Tree)     │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                   查询优化层 (Optimizer Layer)                 │
│                       Query Optimizer                        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                   执行引擎层 (Executor Layer)                  │
│    Operator Pipeline (Scan → Filter → Join → Aggregate)     │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                   事务管理层 (Transaction Layer)               │
│              Transaction Manager + Lock Manager             │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    存储管理层 (Storage Layer)                  │
│         Record Manager + Index Manager + Buffer Pool        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    物理存储层 (Physical Layer)                 │
│                  Page Manager + Disk Files                  │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 模块划分

#### 2.2.1 核心模块

1. **common** - 通用数据类型
   - `Schema`: 表结构定义
   - `Tuple`: 元组（行）表示
   - `Value`: 值类型封装
   - `Types`: 数据类型定义

2. **parser** - SQL 解析模块
   - `Lexer`: 词法分析器
   - `SQLParser`: 语法分析器
   - `Token/TokenType`: 词法单元
   - `ast.*`: 抽象语法树节点

3. **optimizer** - 查询优化模块
   - `QueryOptimizer`: 查询优化器

4. **executor** - 执行引擎模块
   - `Operator`: 操作符基类
   - `SeqScanOperator`: 顺序扫描
   - `FilterOperator`: 过滤操作
   - `JoinOperator`: 连接操作
   - `ProjectOperator`: 投影操作
   - `AggregateOperator`: 聚合操作
   - `SortOperator`: 排序操作
   - `QueryExecutor`: 查询执行器

5. **storage** - 存储管理模块
   - `StorageManager`: 存储管理器
   - `PageManager`: 页管理器
   - `RecordManager`: 记录管理器
   - `Page`: 页结构
   - `RecordId`: 记录标识

6. **index** - 索引模块
   - `BPlusTree`: B+ 树实现
   - `BPlusTreePageManager`: B+ 树页管理
   - `IndexManager`: 索引管理器

7. **buffer** - 缓冲池模块
   - `BufferPool`: 缓冲池管理（LRU 策略）

8. **transaction** - 事务管理模块
   - `Transaction`: 事务对象
   - `TransactionManager`: 事务管理器

9. **lock** - 锁管理模块
   - `LockManager`: 锁管理器

10. **catalog** - 元数据管理模块
    - `Catalog`: 系统目录

11. **jdbc** - JDBC 驱动模块
    - `JdbcDriver`: JDBC 驱动
    - `JdbcConnection`: 数据库连接
    - `JdbcStatement`: 语句对象
    - `JdbcPreparedStatement`: 预编译语句
    - `JdbcResultSet`: 结果集
    - `JdbcResultSetMetaData`: 结果集元数据
    - `JdbcDatabaseMetaData`: 数据库元数据

12. **engine** - 数据库引擎
    - `Database`: 数据库主引擎

## 3. 核心技术实现

### 3.1 SQL 解析流程

```
SQL 语句 → Lexer (词法分析) → Tokens → Parser (语法分析) → AST
```

**支持的 SQL 语句：**
- `CREATE TABLE`: 建表语句
- `INSERT INTO`: 插入数据
- `SELECT`: 查询语句（支持 WHERE、JOIN、GROUP BY、ORDER BY）
- `UPDATE`: 更新数据
- `DELETE`: 删除数据

### 3.2 存储结构

#### 页式存储
- **页大小**: 4KB (可配置)
- **页结构**: Header + Records + Free Space
- **记录格式**: 定长记录存储

#### B+ 树索引
- **特性**: 支持范围查询和点查询
- **节点结构**: 内部节点存储键和指针，叶子节点存储键值对
- **分裂策略**: 节点满时自动分裂

### 3.3 缓冲池管理

- **替换策略**: LRU (Least Recently Used)
- **缓存大小**: 可配置的页数
- **脏页管理**: 支持脏页标记和刷盘

### 3.4 事务处理

#### ACID 特性
- **原子性 (Atomicity)**: 通过日志和回滚实现
- **一致性 (Consistency)**: 通过约束检查保证
- **隔离性 (Isolation)**: 通过锁机制实现
- **持久性 (Durability)**: 通过日志持久化保证

#### 并发控制
- **锁粒度**: 支持行锁和表锁
- **锁类型**: 共享锁 (S) 和排他锁 (X)
- **死锁检测**: 超时机制

### 3.5 查询执行

#### 执行模型
- **火山模型 (Volcano Model)**: 基于迭代器的执行方式
- **操作符管道**: open() → next() → close()

#### 支持的操作符
1. **SeqScan**: 全表扫描
2. **Filter**: 谓词过滤
3. **Project**: 列投影
4. **Join**: 嵌套循环连接
5. **Aggregate**: 聚合函数 (COUNT, SUM, AVG, MIN, MAX)
6. **Sort**: 排序操作

### 3.6 查询优化

#### 优化策略
1. **谓词下推**: 将过滤条件下推到扫描阶段
2. **投影下推**: 尽早减少列数
3. **索引选择**: 优先使用索引扫描
4. **连接顺序优化**: 基于表大小选择连接顺序

## 4. 数据流程

### 4.1 查询执行流程

```
SQL 查询
    ↓
词法分析 (Lexer)
    ↓
语法分析 (Parser)
    ↓
生成 AST
    ↓
查询优化 (Optimizer)
    ↓
生成执行计划 (Operator Tree)
    ↓
执行引擎 (Executor)
    ↓
事务管理 (Transaction Manager)
    ↓
锁管理 (Lock Manager)
    ↓
索引查找 (Index Manager) / 全表扫描 (Record Manager)
    ↓
缓冲池 (Buffer Pool)
    ↓
页管理 (Page Manager)
    ↓
磁盘 I/O
    ↓
返回结果
```

### 4.2 插入数据流程

```
INSERT 语句
    ↓
SQL 解析
    ↓
事务开始
    ↓
获取写锁
    ↓
记录管理器分配空间
    ↓
写入数据页
    ↓
更新索引
    ↓
标记脏页
    ↓
记录日志
    ↓
事务提交
    ↓
释放锁
    ↓
返回成功
```

## 5. JDBC 接口实现

### 5.1 驱动注册

```java
// 自动注册机制
META-INF/services/java.sql.Driver
```

### 5.2 连接 URL 格式

```
jdbc:jdatabase:<database-path>
```

### 5.3 支持的 JDBC 功能

- `Connection`: 数据库连接管理
- `Statement`: 普通 SQL 语句执行
- `PreparedStatement`: 预编译语句（参数绑定）
- `ResultSet`: 结果集遍历
- `DatabaseMetaData`: 数据库元信息查询
- `ResultSetMetaData`: 结果集元信息

## 6. 性能特性

### 6.1 优化策略

1. **缓冲池**: 减少磁盘 I/O
2. **B+ 树索引**: 加速数据检索
3. **查询优化**: 减少不必要的计算
4. **批量操作**: 支持批量插入

### 6.2 并发性能

- 支持多事务并发执行
- 行级锁减少锁冲突
- 超时机制避免死锁

## 7. 目录结构

```
Jdatabase/
├── src/main/java/com/jdatabase/
│   ├── buffer/          # 缓冲池管理
│   ├── catalog/         # 元数据管理
│   ├── common/          # 通用数据类型
│   ├── engine/          # 数据库引擎
│   ├── executor/        # 执行引擎
│   ├── index/           # 索引管理
│   ├── jdbc/            # JDBC 驱动
│   ├── lock/            # 锁管理
│   ├── optimizer/       # 查询优化
│   ├── parser/          # SQL 解析
│   ├── storage/         # 存储管理
│   └── transaction/     # 事务管理
├── src/test/java/       # 单元测试
└── src/main/resources/  # 资源文件
```

## 8. 技术栈

- **语言**: Java 8+
- **构建工具**: Maven
- **测试框架**: JUnit
- **编码规范**: Java Code Conventions

## 9. 扩展性设计

### 9.1 可扩展点

1. **存储引擎**: 可替换不同的存储实现
2. **索引类型**: 可添加哈希索引、位图索引等
3. **执行器**: 可添加新的操作符
4. **优化规则**: 可扩展优化策略
5. **数据类型**: 可添加新的数据类型支持

### 9.2 未来改进方向

1. **查询优化**: 基于代价的优化器
2. **并发控制**: MVCC 多版本并发控制
3. **恢复机制**: WAL 日志和 checkpoint
4. **网络支持**: C/S 架构支持
5. **SQL 完整性**: 更多 SQL 标准支持
6. **分布式**: 分布式事务和存储

## 10. 使用示例

### 10.1 直接 API 使用

```java
Database db = new Database("test.db");
db.execute("CREATE TABLE users (id INT, name VARCHAR, age INT)");
db.execute("INSERT INTO users VALUES (1, 'Alice', 25)");
Database.Result result = db.execute("SELECT * FROM users WHERE age > 20");
```

### 10.2 JDBC 方式使用

```java
Class.forName("com.jdatabase.jdbc.JdbcDriver");
Connection conn = DriverManager.getConnection("jdbc:jdatabase:test.db");
Statement stmt = conn.createStatement();
ResultSet rs = stmt.executeQuery("SELECT * FROM users");
while (rs.next()) {
    System.out.println(rs.getInt("id") + ", " + rs.getString("name"));
}
```

## 11. 测试覆盖

- 单元测试覆盖所有核心模块
- 集成测试验证端到端功能
- 并发测试验证事务隔离性
- 性能测试评估系统吞吐量

---

**文档版本**: 1.0  
**最后更新**: 2025-12-23
